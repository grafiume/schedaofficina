(()=>{if(window.__ELIP_PREV_LITE__)return;window.__ELIP_PREV_LITE__=!0;const e=window.SUPABASE_URL,t=window.SUPABASE_ANON_KEY,n=document.getElementById("preventivo_url"),o=document.getElementById("prev_help"),a=document.getElementById("btn_prev_save"),i=document.getElementById("btn_prev_open");if(!n||!a||!i)return void console.warn("preventivo-link: elementi mancanti");function r(){var e;return(null==(e=document.body)||null==e?void 0:e.dataset.recordId)||null}function d(){try{return(new URLSearchParams(location.search)).get("rid")||new URLSearchParams(location.search).get("id")}catch{return null}}function l(){return window.ELIP_RECORD_ID||null}function s(){return r()||d()||l()}function c(e){return!!e&&/^https?:\/\//i.test((e||"").trim())}function u(e){try{return new URL((e||"").trim()).toString()}catch{return(e||"").trim()}}async function p(n){if(!n)return void(n=await(await fetch(`${e}/rest/v1/records?select=preventivo_url&id=eq.${encodeURIComponent(n)}`,{headers:{apikey:t,Authorization:`Bearer ${t}`}})).json());const a=await(await fetch(`${e}/rest/v1/records?select=preventivo_url&id=eq.${encodeURIComponent(n)}`,{headers:{apikey:t,Authorization:`Bearer ${t}`}})).json();const i=Array.isArray(a)&&a[0]&&a[0].preventivo_url||"";return i}async function m(e){await fetch(`${window.SUPABASE_URL}/rest/v1/records?id=eq.${encodeURIComponent(e)}`,{method:"PATCH",headers:{"content-type":"application/json",apikey:window.SUPABASE_ANON_KEY,Authorization:`Bearer ${window.SUPABASE_ANON_KEY}`,Prefer:"return=minimal"},body:JSON.stringify({preventivo_url:n.value?u(n.value):null})})}async function v(e){if(!e)return n.value="",o.textContent="ID scheda non disponibile: imposta window.ELIP_RECORD_ID o data-record-id sulla pagina.",a.disabled=!0,i.href="#",void(i.style.pointerEvents="none");a.disabled=!1,o.textContent="";try{const t=await p(e);n.value=t||"",f(),t&&(o.textContent="Link caricato ✔")}catch(e){o.textContent="Impossibile caricare il link"}}function f(){const e=u(n.value||"");c(e)?(i.href=e,i.style.opacity=1,i.style.pointerEvents="auto"):(i.href="#",i.style.opacity=.6,i.style.pointerEvents="none")}n.addEventListener("input",f),a.addEventListener("click",async()=>{const e=s();if(!e)return void(o.textContent="ID scheda non disponibile");const t=u(n.value||"");if(t&&!c(t))return void(o.textContent="Inserisci un link http/https valido");const r=a.textContent;a.disabled=!0,a.textContent="Salvo...",o.textContent="";try{await m(e),o.style.color="#0a0",o.textContent="Link salvato ✔"}catch(e){o.style.color="#c00",o.textContent="Errore salvataggio"}finally{a.disabled=!1,a.textContent=r,setTimeout((()=>o.style.color="#666"),1500)}});const h=/iPad|iPhone|iPod/.test(navigator.userAgent);i.addEventListener("click",(e=>{const t=u(n.value||"");c(t)&&(h&&(e.preventDefault(),location.href=t))}));const w=new MutationObserver((()=>{const e=s();e&&v(e)}));w.observe(document.body,{attributes:!0,attributeFilter:["data-record-id"]}),v(s())})();