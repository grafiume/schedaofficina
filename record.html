<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Scheda • Dettaglio</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" href="favicon.ico">
  <meta name="robots" content="noindex">
  <style>
    body { background:#f8f9fa; }
    .container-narrow{ max-width:980px; }
    .label { font-size:.8rem; color:#6c757d; text-transform:uppercase; letter-spacing:.03em; }
    .value { font-size:1.05rem; }
    .kv { margin-bottom:.5rem; }
    .thumb { width:100%; height:auto; max-height:420px; object-fit:cover; border-radius:.5rem; }
    .muted { color:#6c757d; }
    /* Richiesta: campi cliente in rosso e grassetto */
    .value-strong { font-weight:700; color:#d22; }
  </style>
</head>
<body>
  <div class="container container-narrow py-4">
    <header class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h4 mb-0">ELIP TAGLIENTE • Scheda</h1>
      <div class="d-flex gap-2 align-items-center">
        <a id="linkPreventivo" class="btn btn-outline-primary btn-sm d-none" target="_blank" rel="noopener">Apri preventivo</a>
        <button id="btnCreaPreventivo" class="btn btn-primary btn-sm" type="button">Crea Preventivo</button>
        <a class="btn btn-outline-secondary btn-sm" href="index.html">Home</a>
      </div>
    </header>

    <div id="alert" class="alert d-none" role="alert"></div>

    <div id="loading" class="text-center py-5">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <div class="mt-2 muted">Caricamento…</div>
    </div>

    <div id="content" class="d-none">
      <div class="row g-3 align-items-start">
        <div class="col-md-7">
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <div class="kv"><span class="label">Cliente</span><div class="value value-strong" id="fCliente">—</div></div>
              <div class="kv"><span class="label">Descrizione</span><div class="value" id="fDescrizione">—</div></div>
              <div class="kv"><span class="label">Modello</span><div class="value" id="fModello">—</div></div>
              <div class="kv"><span class="label">Stato</span><div class="value" id="fStato">—</div></div>
              <div class="row">
                <div class="col-6 kv"><span class="label">Telefono</span><div class="value value-strong" id="fTelefono">—</div></div>
                <div class="col-6 kv"><span class="label">Email</span><div class="value value-strong" id="fEmail">—</div></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-5">
          <div class="card shadow-sm">
            <div class="card-body">
              <h2 class="h6 text-uppercase text-muted mb-2">Anteprima immagine</h2>
              <div id="imgBox" class="text-center">
                <div id="noImg" class="text-muted">Nessuna immagine disponibile</div>
                <img id="heroImg" class="thumb d-none" alt="Anteprima"/>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <h2 class="h6 text-uppercase text-muted">Dati tecnici</h2>
              <div class="row">
                <div class="col-6 kv"><span class="label">Batt. Collettore</span><div class="value" id="fBatt">—</div></div>
                <div class="col-6 kv"><span class="label">Lunghezza Asse</span><div class="value" id="fAsse">—</div></div>
                <div class="col-6 kv"><span class="label">Lunghezza Pacco</span><div class="value" id="fPacco">—</div></div>
                <div class="col-6 kv"><span class="label">Larghezza Pacco</span><div class="value" id="fLarg">—</div></div>
                <div class="col-6 kv"><span class="label">Punta</span><div class="value" id="fPunta">—</div></div>
                <div class="col-6 kv"><span class="label"># Punte</span><div class="value" id="fNP">—</div></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <h2 class="h6 text-uppercase text-muted">Date</h2>
              <div class="row">
                <div class="col-6 kv"><span class="label">Apertura</span><div class="value" id="fApertura">—</div></div>
                <div class="col-6 kv"><span class="label">Accettazione</span><div class="value" id="fAccettazione">—</div></div>
                <div class="col-6 kv"><span class="label">Scadenza</span><div class="value" id="fScadenza">—</div></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <h2 class="h6 text-uppercase text-muted">Note</h2>
          <div id="fNote" class="value">—</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Librerie + config/officina -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="record.js"></script>

  <!-- Integrazione preventivi (includi UNA SOLA VOLTA) -->
  <script src="./crea-preventivo.js"></script>

  <!-- Bind: usa i valori REALI già mostrati nella pagina (non solo id) -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const schedaId = new URLSearchParams(location.search).get("id");

      // prova a recuperare il record da variabili globali se le hai (se record.js le espone)
      function getRecordFromGlobals() {
        return window.currentRecord || window.record || window.__record || null;
      }

      // fallback: costruisce recordData leggendo i campi già renderizzati in pagina
      function getRecordFromDOM() {
        const t = (id) => (document.getElementById(id)?.textContent || "").trim();
        const recordData = {
          id: schedaId,
          cliente: t("fCliente"),
          telefono: t("fTelefono"),
          email: t("fEmail"),
          descrizione: t("fDescrizione"),
          modello: t("fModello"),
          statoPratica: t("fStato"),
          note: t("fNote"),
          docTrasporto: null
        };
        // se i campi sono ancora "—", li consideriamo non pronti
        const notReady = (!recordData.cliente || recordData.cliente === "—") && (!recordData.descrizione || recordData.descrizione === "—");
        return notReady ? null : recordData;
      }

      // Per salvare il link su DB officina serve un client supabase accessibile.
      // Se record.js non lo espone, proviamo a crearlo da config.js (molte volte definisce SUPABASE_URL e SUPABASE_ANON_KEY).
      function ensureOfficinaClientGlobal() {
        if (window.supabaseClient || window.supabase_officina) return window.supabaseClient || window.supabase_officina;
        // supabase-js v2 espone "supabase" come namespace globale
        const ns = window.supabase;
        if (!ns || typeof ns.createClient !== "function") return null;

        const url = window.SUPABASE_URL || window.supabaseUrl || window.supabase_url;
        const key = window.SUPABASE_ANON_KEY || window.supabaseAnonKey || window.supabase_anon_key;
        if (!url || !key) return null;

        const client = ns.createClient(url, key);
        window.supabaseClient = client;
        return client;
      }

      ensureOfficinaClientGlobal();

      // aspetta che la pagina abbia i dati (record.js è async)
      const btn = document.getElementById("btnCreaPreventivo");
      if (!btn) return;

      const linkEl = document.getElementById("linkPreventivo");

      let tries = 0;
      const timer = setInterval(() => {
        tries++;

        const rec = getRecordFromGlobals() || getRecordFromDOM();
        if (rec) {
          clearInterval(timer);

          // se in futuro record.js espone preventivo_url, mostralo
          const existingUrl = rec.preventivo_url || null;
          if (existingUrl && linkEl) {
            linkEl.href = existingUrl;
            linkEl.classList.remove("d-none");
          }

          // bind con il record completo (così invia "voci" al preventivo)
          if (typeof window.bindCreaPreventivoButton === "function") {
            window.bindCreaPreventivoButton(rec, {
              saveLinkToScheda: true,
              updateLinkElementId: "linkPreventivo"
            });
          } else {
            console.warn("bindCreaPreventivoButton non disponibile: controlla crea-preventivo.js");
          }
        }

        // timeout dopo ~10s
        if (tries > 40) {
          clearInterval(timer);
          console.warn("Record non pronto: non riesco a leggere i campi per il preventivo (dati non renderizzati).");
          // fallback minimo: bind solo id
          if (typeof window.bindCreaPreventivoButton === "function") {
            window.bindCreaPreventivoButton({ id: schedaId }, { saveLinkToScheda: false });
          }
        }
      }, 250);
    });
  </script>
</body>
</html>
