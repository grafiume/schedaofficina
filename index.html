<!doctype html><html lang="it"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Scheda riparazioni</title>
<meta name="theme-color" content="#e07b39">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
:root{ --brand-gray:#505050; --brand-orange:#e07b39; --brand-green:#1e8b3d; --brand-red:#c63c3c;
       --brand-bg:#faf9f7; --brand-border:#e8e4df; }
body{padding-bottom:84px;background:var(--brand-bg)}
.header-bar{border-bottom:1px solid var(--brand-border);background:#fff}
.brand-wrap{display:flex;align-items:center;justify-content:center;padding:.6rem 1rem;gap:.8rem}
.brand-logo{height:72px}
.brand-title{font-weight:800;color:var(--brand-gray);font-size:1.4rem;text-transform:uppercase;letter-spacing:.5px}
.header-actions{position:absolute;right:12px;top:12px;display:flex;gap:.5rem}
.btn-primary{background:var(--brand-orange);border-color:var(--brand-orange)}
.btn-primary:hover{background:#cf6e32;border-color:#cf6e32}
.btn-outline-secondary{color:var(--brand-gray);border-color:var(--brand-gray)}
.thumb{width:64px;height:64px;object-fit:cover;border:1px solid #ddd;border-radius:8px;cursor:pointer}
.photo-preview{width:100%;max-height:520px;object-fit:contain;border:1px dashed #bbb;border-radius:8px;cursor:pointer}
.sticky{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--brand-border);padding:10px}
.section{margin-top:16px}
.kpi{min-width:160px;border:1px solid var(--brand-border)}
.kpi .card-body{padding:.9rem}
.kpi-link{cursor:pointer;transition:transform .05s}
.kpi-link:active{transform:scale(0.99)}
.table-list td{vertical-align:middle}
.card{border-color:var(--brand-border)}
.card .table{margin-bottom:0}
fieldset{border:1px solid var(--brand-border)!important;border-radius:.6rem;padding:12px;margin-bottom:14px;background:#fff}
legend{font-size:0.95rem;width:auto;padding:0 8px;margin:0;color:#6c757d}
.small-muted{font-size:.875rem;color:#6c757d}
.badge-filter{vertical-align:middle}
.pagination .page-link{cursor:pointer}
.kpi.border-top-green{border-top:4px solid var(--brand-green)}
.kpi.border-top-red{border-top:4px solid var(--brand-red)}
.kpi.border-top-orange{border-top:4px solid var(--brand-orange)}
.form-control-lgx{padding:.7rem 1rem;font-size:1.05rem}
.red-label{color:var(--brand-red)}
.input-red{border-color:#f0b1b1}
.input-red:focus{border-color:var(--brand-red);box-shadow:0 0 0 .25rem rgba(198,60,60,.15)}
.table-fixed{table-layout:fixed}
.desc-col{font-size:.95em;white-space:normal;line-height:1.25}
.nowrap{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.actions-col{width:140px}
.input-xxs{max-width:72px;text-align:center}

/* === Layout Modifica/Nuova scheda: due colonne senza scroll pagina === */
@media (min-width: 992px){
  #page-form .form-flex{
    height: calc(100vh - 220px); /* header + titolo + sticky */
    display: flex;
    gap: 1rem;
  }
  #page-form .left-pane, #page-form .right-pane{ height: 100%; }
  #page-form .left-pane{
    overflow: auto;             /* scorre solo la colonna di sinistra se serve */
    padding-right: .5rem;
  }
  #page-form .right-pane{ overflow: hidden; }
}
/* Card anteprima a destra */
.preview-card{
  height: 100%;
  border:1px solid var(--brand-border);
  border-radius:.75rem;
  background:#fff;
  padding:1rem;
  display:flex;
  flex-direction:column;
  gap:.75rem;
}
/* Riquadro immagine a proporzione fissa (4:3) */
.image-box{
  position:relative;
  width:100%;
  aspect-ratio: 4 / 3;          /* Cambia in 1/1 o 16/9 se preferisci */
  border:1px dashed #c8c8c8;
  border-radius:.5rem;
  background:#f8f9fa;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
}
.image-box img{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:contain;             /* riempie senza deformare */
}
.image-box .empty-hint{
  color:#8a8a8a;
  font-size:.95rem;
  text-align:center;
  padding:0 1rem;
}
/* Spazio per evitare che la sticky copra il form */
#page-form .left-pane{ padding-bottom: 96px; }

/* --- Miniature immagini (thumbnail strip) --- */
.thumb-strip{
  display:flex;
  gap:.5rem;
  overflow:auto;
  padding:.25rem 0;
  border-top:1px dashed #e0e0e0;
}
.thumb-strip .thumb-item{
  width:64px;
  height:64px;
  border:1px solid #ddd;
  border-radius:.375rem;
  overflow:hidden;
  flex:0 0 auto;
  cursor:pointer;
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
}
.thumb-strip .thumb-item img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.thumb-strip .thumb-item.active{
  outline:2px solid var(--brand-orange);
  outline-offset:2px;
}

/* === Allineamento preciso riquadro "Dati tecnici" (4 campi) === */
@media (min-width: 992px){
  .tech-grid{
    display: grid !important;
    grid-template-columns: 1fr 1fr 0.6fr 1fr;
    gap: .75rem 1rem;
    align-items: start;              /* evita sfasamenti verticali */
  }
}
/* Etichette consistenti */
.tech-grid .form-label{
  margin-bottom: .35rem;
  line-height: 1.15;
  white-space: nowrap;               /* evita label su due righe */
}
/* Altezza uniforme per input/select/textarea (Note a 1 riga) */
.tech-grid .form-control,
.tech-grid .form-select,
.tech-grid textarea{
  height: 42px;                      /* controlli uniformi */
  padding-top: .45rem;
  padding-bottom: .45rem;
}
/* Textarea Note come campo mono-riga */
.tech-grid textarea{
  resize: vertical;                  /* consentito all'occorrenza */
}
/* Evita che i campi "N. punte" stringano troppo */
.tech-grid [name="numPunte"]{
  min-width: 80px;
  text-align: center;
}

/* Evidenzia scadenze urgenti (<=3 giorni) o scadute */
.date-urgent{ color: var(--brand-red); font-weight:600; }
</style></head><body>
<!-- HEADER -->
<header class="header-bar position-relative">
  <div class="brand-wrap">
    <img class="brand-logo" src="logo-elip.jpg" alt="Elip Tagliente">
    <span class="brand-title">Scheda riparazioni</span>
  </div>
  <div class="header-actions">
    <button id="btnHome" class="btn btn-sm btn-outline-secondary" type="button">Home</button>
    <button id="btnSearch" class="btn btn-sm btn-primary" type="button">Ricerca</button>
  </div>
</header>

<!-- HOME -->
<div class="container my-3" id="page-home">
  <div class="d-flex gap-2 flex-wrap mb-3">
    <button class="card kpi kpi-link border-top-orange text-start" type="button" data-filter="totali" id="kpiTotBtn">
      <div class="card-body"><div class="small text-muted">Totali</div><div class="h4 mb-0" id="kpiTot">0</div></div>
    </button>
    <button class="card kpi kpi-link border-top-green text-start" type="button" data-filter="attesa" id="kpiAttesaBtn">
      <div class="card-body"><div class="small text-muted">In attesa</div><div class="h4 mb-0" id="kpiAttesa">0</div></div>
    </button>
    <button class="card kpi kpi-link border-top-orange text-start" type="button" data-filter="lavorazione" id="kpiLavorBtn">
      <div class="card-body"><div class="small text-muted">In lavorazione</div><div class="h4 mb-0" id="kpiLavor">0</div></div>
    </button>
    <button class="card kpi kpi-link border-top-red text-start" type="button" data-filter="soon" id="kpiSoonBtn">
      <div class="card-body"><div class="small text-muted">Scadenze 7gg</div><div class="h4 mb-0" id="kpiSoon">0</div></div>
    </button>
    <button class="card kpi kpi-link text-start" type="button" data-filter="completed" id="kpiComplBtn">
      <div class="card-body"><div class="small text-muted">Completate/Chiuse</div><div class="h4 mb-0" id="kpiCompl">0</div></div>
    </button>
  </div>

  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Tutte le schede (aperte) <span class="small-muted">â€” esclude Completata</span></span>
      <div class="btn-group">
        <button id="newRecord" class="btn btn-primary btn-sm" type="button">+ Nuova scheda</button>
        <button id="goSearch" class="btn btn-outline-secondary btn-sm" type="button">Vai a Ricerca</button>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle table-list table-fixed">
        <colgroup>
          <col style="width:72px"><col style="width:36%"><col style="width:17%">
          <col style="width:12%"><col style="width:12%"><col class="actions-col">
        </colgroup>
        <thead><tr>
          <th>Foto</th><th>Descrizione/Modello</th><th>Cliente</th><th>Telefono</th>
          <th>Data arrivo</th><th class="text-end">Azioni</th>
        </tr></thead>
        <tbody id="listAllOpenBody"><tr><td colspan="6" class="text-muted">Nessuna scheda</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="d-grid gap-2">
    <button id="exportZip" class="btn btn-outline-dark" type="button">Backup (ZIP)</button>
    <label class="btn btn-outline-success" for="importZip">Ripristina da ZIP</label>
    <input id="importZip" type="file" accept=".zip" hidden>
  </div>
</div>

<!-- FORM -->
<div class="container my-3 d-none" id="page-form">
  <h4 class="mb-2" id="formTitle">Nuova scheda</h4>

  <!-- Layout due colonne: SINISTRA campi, DESTRA anteprima -->
  <div class="form-flex">
    <!-- SINISTRA -->
    <div class="left-pane flex-grow-1">
      <form id="recordForm" class="g-2" onsubmit="return false">
        <input type="hidden" name="numero">
        <input type="hidden" name="dataCompletamento">

        <fieldset>
          <legend>Dati scheda e cliente</legend>

          <div class="row g-2 mb-1">
            <div class="col-lg-8 col-md-7">
              <label class="form-label">Descrizione</label>
              <input name="descrizione" class="form-control form-control-lgx" placeholder="es. Motore trifase 4kW...">
            </div>
            <div class="col-lg-4 col-md-5">
              <label class="form-label">Modello</label>
              <input name="modello" class="form-control form-control-lgx" placeholder="es. XYZ-123">
            </div>
          </div>

          <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-2">
            <div class="col"><label class="form-label">Data apertura</label><input lang="it-IT" placeholder="gg/mm/aaaa" name="dataApertura" type="date" class="form-control"></div>
            <div class="col"><label class="form-label">Data accettazione</label><input lang="it-IT" placeholder="gg/mm/aaaa" name="dataAccettazione" type="date" class="form-control"></div>
            <div class="col"><label class="form-label">Data scadenza</label><input lang="it-IT" placeholder="gg/mm/aaaa" name="dataScadenza" type="date" class="form-control"></div>

            <div class="col">
              <label class="form-label"><span id="statoLabelText">Stato</span> <small id="completataInline" class="text-muted ms-2 d-none">(Chiusa il <span id="completataDate"></span>)</small></label>
              <select name="statoPratica" id="statoPratica" class="form-select">
                <option selected>In attesa</option><option>In lavorazione</option><option>Completata</option>
              </select>
            </div>

            <div class="col">
              <label class="form-label">Preventivo</label>
              <select name="preventivoStato" id="preventivoStato" class="form-select">
                <option>Non inviato</option><option>Inviato</option>
              </select>
            </div>

            <div class="col">
              <label class="form-label">Documento Trasporto</label>
              <input name="docTrasporto" class="form-control" placeholder="Numero / riferimento DDT">
            </div>

            <div class="col">
              <label class="form-label red-label">Nome / Ragione sociale</label>
              <input name="cliente" class="form-control input-red">
            </div>
            <div class="col">
              <label class="form-label red-label">Telefono</label>
              <input name="telefono" class="form-control input-red">
            </div>
            <div class="col">
              <label class="form-label red-label">Email</label>
              <input name="email" type="email" class="form-control input-red">
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Dati tecnici</legend>
          <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-2">
            <div class="col"><label class="form-label">Batt. collettore</label><input name="battCollettore" class="form-control"></div>
            <div class="col"><label class="form-label">Lunghezza asse</label><input name="lunghezzaAsse" class="form-control"></div>
            <div class="col"><label class="form-label">Lunghezza pacco</label><input name="lunghezzaPacco" class="form-control"></div>
            <div class="col"><label class="form-label">Larghezza pacco</label><input name="larghezzaPacco" class="form-control"></div>

            <div class="col d-flex gap-2 align-items-end">
              <div class="flex-fill">
                <label class="form-label">Punta</label>
                <select name="punta" class="form-select"><option></option><option>Destra</option><option>Sinistra</option><option>Dritta</option></select>
              </div>
              <div>
                <label class="form-label">N. punte</label>
                <input name="numPunte" class="form-control input-xxs" inputmode="numeric" pattern="\d{1,2}" maxlength="2" placeholder="0" title="Inserisci 1â€“2 cifre">
              </div>
            </div>

            <div class="col-12"><label class="form-label">Note</label><textarea name="note" rows="2" class="form-control" placeholder="Annotazioni tecniche, lavorazioni, ecc."></textarea></div>
          </div>
        </fieldset>

      </form>
      <div class="sticky d-grid gap-2">
        <button id="saveRecord" class="btn btn-primary" type="button">Salva scheda</button>
        <button id="cancelForm" class="btn btn-outline-secondary" type="button">Annulla</button>
      </div>
    </div>

    <!-- DESTRA: ANTEPRIMA PRINCIPALE + UPLOAD multiplo sotto -->
    <div class="right-pane col-lg-5 col-12">
      <div class="preview-card">
        <div class="d-flex align-items-center justify-content-between">
          <div class="fw-semibold">Anteprima immagine</div>
          <div class="small text-muted">4:3 â€¢ adattata</div>
        </div>

        <div class="image-box" id="mainPreviewBox" role="button">
          <img id="photoPreview" alt="Anteprima">
          <div class="empty-hint" id="emptyHint">Nessuna immagine disponibile</div>
        </div>

        <div>
          <label for="photoInput" class="form-label mb-1">Carica immagini (multiplo)</label>
          <input id="photoInput" type="file" accept="image/*" class="form-control" multiple>
          <div class="small-muted mt-1">Suggerimento: la prima immagine caricata verrÃ  mostrata qui sopra.</div>
<div id="thumbStrip" class="thumb-strip mt-2" aria-label="Anteprime immagini"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- RICERCA -->
<div class="container my-3 d-none" id="page-search">
  <h4>Ricerca</h4>

  <div id="activeFilterBox" class="mb-2 d-none">
    <span class="badge text-bg-info badge-filter" id="activeFilterLabel"></span>
    <button class="btn btn-sm btn-outline-secondary ms-2" id="btnClearFilter" type="button">Rimuovi filtro</button>
  </div>

  <div class="row g-2 mb-2">
    <div class="col-md-10"><input id="q" class="form-control" placeholder="Cerca per descrizione, modello, cliente, telefono, DDT e dati tecnici (ammessi)â€¦"></div>
    <div class="col-md-2 d-grid"><button id="btnDoSearch" class="btn btn-primary" type="button">Cerca</button></div>
  </div>

  <div class="card mb-2">
    <div class="card-header py-2">Filtri tecnici (singoli)</div>
    <div class="card-body py-2">
      <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-2">
        <div class="col"><input id="f_battCollettore" class="form-control" placeholder="Batt. collettore"></div>
        <div class="col"><input id="f_lunghezzaAsse" class="form-control" placeholder="Lunghezza asse"></div>
        <div class="col"><input id="f_lunghezzaPacco" class="form-control" placeholder="Lunghezza pacco"></div>
        <div class="col"><input id="f_larghezzaPacco" class="form-control" placeholder="Larghezza pacco"></div>
        <div class="col d-flex gap-2">
          <select id="f_punta" class="form-select">
            <option value="">Punta (tutte)</option><option>Destra</option><option>Sinistra</option><option>Dritta</option>
          </select>
          <input id="f_numPunte" class="form-control input-xxs" inputmode="numeric" pattern="\\d{1,2}" maxlength="2" placeholder="N.">
        </div>
      </div>
      <div class="mt-2 d-flex gap-2">
        <button id="btnApplyFilters" class="btn btn-outline-primary btn-sm" type="button">Applica filtri</button>
        <button id="btnResetFilters" class="btn btn-outline-secondary btn-sm" type="button">Reset</button>
      </div>
    </div>
  </div>

  <div class="table-responsive">
  <table class="table table-hover align-middle table-fixed" id="tableResults">
    <colgroup>
      <col style="width:72px"><col style="width:32%"><col style="width:16%"><col style="width:12%">
      <col style="width:10%"><col style="width:10%"><col style="width:10%"><col style="width:10%"><col class="actions-col">
    </colgroup>
    <thead><tr>
      <th>Foto</th><th>Descrizione/Modello</th><th>Cliente</th><th>Telefono</th>
      <th>Data arrivo</th><th>Data accettazione</th><th>Data scadenza</th><th>Stato</th><th class="text-end">Azioni</th>
    </tr></thead>
    <tbody></tbody>
  </table>
  </div>
  <nav><ul class="pagination justify-content-center my-2" id="pager"></ul></nav>
</div>

<!-- DETTAGLIO -->
<div class="modal fade" id="detailModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">Dettaglio scheda</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body"><div id="detailContent"></div></div>
  <div class="modal-footer">
    <button class="btn btn-outline-dark" id="btnPDF" type="button">PDF</button>
    <button class="btn btn-primary" id="btnEdit" type="button">Modifica</button>
    <button class="btn btn-danger" id="btnDelete" type="button">Elimina</button>
    <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Chiudi</button>
  </div>
</div></div></div>

<!-- FULL IMG -->
<div class="modal fade" id="imgModal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content bg-dark">
  <div class="modal-body d-flex align-items-center justify-content-center p-0">
    <img id="imgFull" class="img-fluid" alt="Foto">
  </div>
  <div class="position-absolute top-0 end-0 p-3"><button class="btn btn-light" data-bs-dismiss="modal">Chiudi</button></div>
</div></div></div>


<!-- IMG CENTERED (popup bianco) -->
<div class="modal fade" id="imgModalCenter" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body p-0">
        <img id="imgCenter" class="img-fluid w-100" alt="Foto">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Chiudi</button>
      </div>
    </div>
  </div>
</div>


<!-- CONFIRM DELETE -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">Conferma eliminazione</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body">Sei sicuro di voler eliminare questa scheda? L'operazione non puÃ² essere annullata.</div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Elimina</button>
  </div>
</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
/* ===== Utils ===== */
const $=s=>document.querySelector(s);
const esc = s => String(s??'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
function parseDate(v){ if(!v) return null; const d=new Date(v); return isNaN(d)?null:d; }
function fmtIT(v){ const d=parseDate(v); return d? d.toLocaleDateString('it-IT') : ''; }

// <= 3 giorni alla scadenza oppure passato => urgente
function isUrgent(d){
  if(!d) return false;
  const today = new Date(); today.setHours(0,0,0,0);
  const due = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const ms = due - today;
  const days = Math.floor(ms / (1000*60*60*24));
  return days <= 3; // include anche scadute (days < 0)
}

function isSoon(d){ if(!d) return false; const t=new Date(); t.setHours(0,0,0,0); const lim=new Date(t); lim.setDate(lim.getDate()+7); return d>=t && d<=lim; }
function newId(){ return (window.crypto && typeof crypto.randomUUID==='function') ? crypto.randomUUID() : Date.now().toString(); }


// === Helpers per data completamento & UI stato ===
function todayISO(){ const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; }
function updateCompletionUI(){
  const statoSel = document.getElementById('statoPratica');
  const info     = document.getElementById('completataInline');
  const infoDate = document.getElementById('completataDate');
  const f        = document.getElementById('recordForm');
  const fldScad  = f && f.elements['dataScadenza'];
  const fldCompl = f && f.elements['dataCompletamento'];
  const isCompl  = statoSel && statoSel.value === 'Completata';
  if(isCompl){
    if(fldCompl && !fldCompl.value) fldCompl.value = todayISO(); // memorizza se manca
    if(fldScad) fldScad.value = ''; // svuota ma resta visibile/attivo
    if(info && infoDate){
      const d = fldCompl && fldCompl.value ? new Date(fldCompl.value) : new Date();
      infoDate.textContent = d.toLocaleDateString('it-IT');
      info.classList.remove('d-none');
    }
  }else{
    if(info) info.classList.add('d-none');
    if(fldCompl) fldCompl.value='';
  }
}

/* ===== IndexedDB ===== */
const DB='officinaDB', VER=2;
function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open(DB,VER);r.onupgradeneeded=e=>{const db=e.target.result;let rec;if(!db.objectStoreNames.contains('records')){rec=db.createObjectStore('records',{keyPath:'id'});}else{rec=r.transaction.objectStore('records');}
if(!rec.indexNames.contains('byStato'))rec.createIndex('byStato','statoPratica',{unique:false});
if(!rec.indexNames.contains('byScadenza'))rec.createIndex('byScadenza','dataScadenza',{unique:false});
if(!rec.indexNames.contains('byUpdated'))rec.createIndex('byUpdated','updatedAt',{unique:false});
if(!db.objectStoreNames.contains('photos'))db.createObjectStore('photos',{keyPath:'id'});};r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});}
async function putRecord(v){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction('records','readwrite');tx.objectStore('records').put(v);tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);});}
async function getRecord(id){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction('records','readonly');const q=tx.objectStore('records').get(id);q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error);});}
async function getAllRecords(){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction('records','readonly');const q=tx.objectStore('records').getAll();q.onsuccess=()=>res(q.result||[]);q.onerror=()=>rej(q.error);});}
async function getByStato(stato){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction('records','readonly');const idx=tx.objectStore('records').index('byStato');const q=idx.getAll(stato);q.onsuccess=()=>res(q.result||[]);q.onerror=()=>rej(q.error);});}
async function deleteRecord(id){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(['records','photos'],'readwrite');tx.objectStore('records').delete(id);tx.objectStore('photos').delete(id);tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);});}
async function savePhotosWithThumbs(id,images,thumbs){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction('photos','readwrite');tx.objectStore('photos').put({id,images,thumbs});tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);});}
async function getPhotos(id){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction('photos','readonly');const q=tx.objectStore('photos').get(id);q.onsuccess=()=>{const v=q.result||{};res({images:v.images||[],thumbs:v.thumbs||[]});};q.onerror=()=>rej(q.error);});}

/* ===== App ===== */
let cur=null, deleteTargetId=null;
const FORCE_ATTESA = false;

let currentFilter=null;
const FILTER_LABELS={totali:'Tutte le schede (tutte)',attesa:'Solo: In attesa',lavorazione:'Solo: In lavorazione',soon:'Solo: Scadenze 7gg',completed:'Solo: Completate/Chiuse'};
const PAGE_SIZE=50; let searchRows=[]; let page=1;
const techFilters={battCollettore:'',lunghezzaAsse:'',lunghezzaPacco:'',larghezzaPacco:'',punta:'',numPunte:''};

function sh(n){$('#page-home').classList.toggle('d-none',n!=='home');$('#page-form').classList.toggle('d-none',n!=='form');$('#page-search').classList.toggle('d-none',n!=='search');}
function f2url(file){return new Promise((res,rej)=>{const R=new FileReader();R.onload=()=>res(R.result);R.onerror=()=>rej(R.error);R.readAsDataURL(file);});}

/* Nuova scheda */
function nuovo(){cur={id:newId(),createdAt:new Date().toISOString()};const f=$('#recordForm');f.reset();$('#formTitle').textContent='Nuova scheda';$('#photoPreview').src='';const s=$('#statoPratica');if(s)s.value='In attesa';const p=$('#preventivoStato');if(p)p.value='Non inviato'; const lbl=document.getElementById('statoLabelText'); if(lbl) lbl.textContent='Stato'; const sm=document.getElementById('completataInline'); if(sm) sm.innerHTML='(Chiusa il <span id="completataDate"></span>)'; if(f && f.elements['dataCompletamento']) f.elements['dataCompletamento'].value=''; sh('form'); updateCompletionUI();}

/* Modifica */
async function modifica(id){const r=await getRecord(id);if(!r){alert('Scheda non trovata');return;}cur=r;const f=$('#recordForm');$('#formTitle').textContent='Modifica scheda';[...f.elements].forEach(el=>{if(el.name&&r[el.name]!=null) el.value=r[el.name];});const s=$('#statoPratica');if(s)s.value=r.statoPratica||'In attesa';const p=$('#preventivoStato');if(p)p.value=r.preventivoStato||'Non inviato';const {images}=await getPhotos(id);$('#photoPreview').src=images[0]||'';const lbl=document.getElementById('statoLabelText'); if(lbl) lbl.textContent='Stato'; const sm=document.getElementById('completataInline'); if(sm) sm.innerHTML='(Chiusa il <span id="completataDate"></span>)'; sh('form'); updateCompletionUI();}

/* Salva */
async function salva(){
  const f=$('#recordForm');
  const d=Object.fromEntries(new FormData(f).entries());
  d.id = cur?.id || newId();
  d.updatedAt = new Date().toISOString();
  if(FORCE_ATTESA) d.statoPratica='In attesa';
  if(!d.preventivoStato) d.preventivoStato='Non inviato';
  // Stato completata => azzera scadenza e memorizza data completamento
  if(d.statoPratica==='Completata'){ 
    if(!d.dataCompletamento){ d.dataCompletamento = todayISO(); }
    d.dataScadenza='';
  } else {
    d.dataCompletamento='';
  }
  // data arrivo = data apertura
  d.dataArrivo = d.dataApertura || '';

  // Foto
  let full=[],thumbs=[];
  const fl=$('#photoInput').files;
  if(fl&&fl.length){for(const file of fl){const data=await f2url(file);full.push(data);thumbs.push(data);}}
  else{const prev=$('#photoPreview').getAttribute('src');if(prev){full=[prev];thumbs=[prev];}}

  await putRecord(d);
  if(full.length||thumbs.length) await savePhotosWithThumbs(d.id,full,thumbs);
  alert('Scheda salvata'); sh('home'); refreshDashboard();
}

/* Rendering thumb + apertura full */
function renderThumb(src,id){return src?`<img class="thumb" loading="lazy" src="${src}" data-id="${id}">`:'<div class="thumb d-flex align-items-center justify-content-center text-secondary">â€”</div>';}

/* HOME: lista aperte (Data arrivo in IT) */
async function populateHomeOpenList(){
  const all=await getAllRecords(); all.sort((a,b)=>(b.updatedAt||'').localeCompare(a.updatedAt||''));
  const open=all.filter(r=>(r.statoPratica||'')!=='Completata');
  const tb=$('#listAllOpenBody');
  if(!open.length){tb.innerHTML='<tr><td colspan="6" class="text-muted">Nessuna scheda</td></tr>';return;}
  const rows=[];
  for(const r of open){
    const {images,thumbs}=await getPhotos(r.id); const th=thumbs[0]||images[0];
    rows.push(`<tr>
      <td>${renderThumb(th,r.id)}</td>
      <td class="desc-col"><strong>${esc(r.descrizione)}</strong> ${esc(r.modello)}</td>
      <td class="nowrap">${esc(r.cliente)}</td>
      <td class="nowrap">${esc(r.telefono)}</td>
      <td class="nowrap">${fmtIT(r.dataApertura||r.dataArrivo||'')}</td>
      <td class="text-end nowrap"><div class="btn-group">
        <button class="btn btn-sm btn-outline-primary" data-open="${r.id}">Apri</button>
        <button class="btn btn-sm btn-outline-success" data-edit="${r.id}">Modifica</button>
      </div></td>
    </tr>`);
  }
  tb.innerHTML=rows.join('');
  tb.querySelectorAll('img.thumb').forEach(img=>{img.addEventListener('click',async()=>{const id=img.getAttribute('data-id');const {images,thumbs}=await getPhotos(id);openImg(images[0]||thumbs[0]);});});
  tb.querySelectorAll('button[data-open]').forEach(b=>b.onclick=()=>apri(b.dataset.open));
  tb.querySelectorAll('button[data-edit]').forEach(b=>b.onclick=()=>modifica(b.dataset.edit));
  
  // Imposta il valore corrente e abilita salvataggio con conferma
  document.querySelectorAll('select.state-edit').forEach(sel=>{
    const id = sel.getAttribute('data-id');
    const row = searchRows.find(r=>r.id===id);
    if(row){ sel.value = row.statoPratica || 'In attesa'; }
    sel.addEventListener('change', async (e)=>{
      const val = e.target.value;
      if(!confirm('Confermi il cambio di stato a "'+val+'"?')){ 
        // ripristina valore precedente
        const rPrev = searchRows.find(r=>r.id===id);
        e.target.value = (rPrev && rPrev.statoPratica) ? rPrev.statoPratica : 'In attesa';
        return;
      }
      try{
        const rec = await getRecord(id);
        if(rec){
          rec.statoPratica = val;
          if(val==='Completata'){ rec.dataCompletamento = todayISO(); rec.dataScadenza=''; } else { rec.dataCompletamento = ''; }
          rec.updatedAt = new Date().toISOString();
          await putRecord(rec);
          // aggiorna cache per la riga e refresh liste/kpi
          const idx = searchRows.findIndex(r=>r.id===id);
          if(idx>=0){ searchRows[idx].statoPratica = val; }
          await refreshDashboard();
          await lista();
        }
      }catch(err){
        alert('Errore nel salvataggio dello stato.');
      }
    });
  });

}

/* Ricerca â€” indice testo (include numPunte) */
function addToSearch(parts,v){if(v)parts.push(String(v).toLowerCase());}
function buildSearchIndex(r){
  const p=[]; addToSearch(p,r.descrizione); addToSearch(p,r.modello); addToSearch(p,r.cliente);
  addToSearch(p,r.telefono); addToSearch(p,r.docTrasporto);
  addToSearch(p,r.battCollettore); addToSearch(p,r.lunghezzaAsse); addToSearch(p,r.lunghezzaPacco);
  addToSearch(p,r.larghezzaPacco); addToSearch(p,r.punta); addToSearch(p,r.numPunte);
  return p.join(' ');
}

/* Filtri tecnici singoli */
function matchTechFilters(r){
  const want=techFilters; const like=(a,b)=>String(a||'').toLowerCase().includes(String(b||'').toLowerCase());
  if(want.battCollettore && !like(r.battCollettore, want.battCollettore)) return false;
  if(want.lunghezzaAsse && !like(r.lunghezzaAsse, want.lunghezzaAsse)) return false;
  if(want.lunghezzaPacco && !like(r.lunghezzaPacco, want.lunghezzaPacco)) return false;
  if(want.larghezzaPacco && !like(r.larghezzaPacco, want.larghezzaPacco)) return false;
  if(want.punta && String(r.punta||'')!==String(want.punta)) return false;
  if(want.numPunte && String(r.numPunte||'')!==String(want.numPunte)) return false;
  return true;
}

/* Paginazione */
const PAGE_SIZE_CONST = 50;
function renderPager(total){
  const pages=Math.max(1,Math.ceil(total/PAGE_SIZE_CONST));
  const ul=$('#pager'); ul.innerHTML='';
  const item=(lbl,target,dis=false,act=false)=>{const li=document.createElement('li');li.className=`page-item ${dis?'disabled':''} ${act?'active':''}`;li.innerHTML=`<span class="page-link">${lbl}</span>`;if(!dis&&!act)li.onclick=()=>{page=target;drawListPage();};ul.appendChild(li);};
  item('Â«',1,page===1); item('â€¹',Math.max(1,page-1),page===1);
  for(let i=1;i<=Math.min(pages,7);i++) item(String(i),i,false,page===i);
  item('â€º',Math.min(pages,page+1),page===pages); item('Â»',pages,page===pages);
}

async function drawListPage(){
  const tb=document.querySelector('#tableResults tbody'); tb.innerHTML='';
  const start=(page-1)*PAGE_SIZE_CONST,end=start+PAGE_SIZE_CONST; const slice=searchRows.slice(start,end);
  if(!slice.length){tb.innerHTML=`<tr><td colspan="9" class="text-muted">Nessun risultato.</td></tr>`;return;}
  for(const r of slice){
    const {images,thumbs}=await getPhotos(r.id); const th=thumbs[0]||images[0];
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${renderThumb(th,r.id)}</td>
      <td class="desc-col"><strong>${esc(r.descrizione)}</strong> ${esc(r.modello)}</td>
      <td class="nowrap">${esc(r.cliente)}</td>
      <td class="nowrap">${esc(r.telefono)}</td>
      <td class="nowrap">${fmtIT(r.dataApertura||r.dataArrivo||'')}</td>
      <td class="nowrap">${fmtIT(r.dataAccettazione)}</td>
      <td class="nowrap">${(()=>{ const d=parseDate(r.dataScadenza); return isUrgent(d) ? `<span class="date-urgent">${fmtIT(r.dataScadenza)}</span>` : fmtIT(r.dataScadenza); })()}</td>
      <td class="nowrap">
      <select class="form-select form-select-sm state-edit" data-id="${r.id}">
        <option value="In attesa">In attesa</option>
        <option value="In lavorazione">In lavorazione</option>
        <option value="Completata">Completata</option>
        
      </select>
    </td>
      <td class="text-end nowrap">
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-primary" data-open="${r.id}">Apri</button>
          <button class="btn btn-sm btn-outline-success" data-edit="${r.id}">Modifica</button>
        </div>
      </td>`;
    tb.appendChild(tr);
  }
  tb.querySelectorAll('img.thumb').forEach(img=>{img.addEventListener('click',async()=>{const id=img.getAttribute('data-id');const {images,thumbs}=await getPhotos(id);openImg(images[0]||thumbs[0]);});});
  tb.querySelectorAll('button[data-open]').forEach(b=>b.onclick=()=>apri(b.dataset.open));
  tb.querySelectorAll('button[data-edit]').forEach(b=>b.onclick=()=>modifica(b.dataset.edit));
  
  // Imposta il valore corrente e abilita salvataggio con conferma
  document.querySelectorAll('select.state-edit').forEach(sel=>{
    const id = sel.getAttribute('data-id');
    const row = searchRows.find(r=>r.id===id);
    if(row){ sel.value = row.statoPratica || 'In attesa'; }
    sel.addEventListener('change', async (e)=>{
      const val = e.target.value;
      if(!confirm('Confermi il cambio di stato a "'+val+'"?')){ 
        // ripristina valore precedente
        const rPrev = searchRows.find(r=>r.id===id);
        e.target.value = (rPrev && rPrev.statoPratica) ? rPrev.statoPratica : 'In attesa';
        return;
      }
      try{
        const rec = await getRecord(id);
        if(rec){
          rec.statoPratica = val;
          if(val==='Completata'){ rec.dataCompletamento = todayISO(); rec.dataScadenza=''; } else { rec.dataCompletamento = ''; }
          rec.updatedAt = new Date().toISOString();
          await putRecord(rec);
          // aggiorna cache per la riga e refresh liste/kpi
          const idx = searchRows.findIndex(r=>r.id===id);
          if(idx>=0){ searchRows[idx].statoPratica = val; }
          await refreshDashboard();
          await lista();
        }
      }catch(err){
        alert('Errore nel salvataggio dello stato.');
      }
    });
  });

}

/* Ricerca pipeline */
async function lista(){
  const q=($('#q').value||'').toLowerCase();
  let rows;
  if(currentFilter==='attesa'||currentFilter==='lavorazione'||currentFilter==='completed'){
    if(currentFilter==='completed'){const comp=await getByStato('Completata');const cons=await getByStato('Consegnata');rows=[...comp,...cons];}
    else{const stato=currentFilter==='attesa'?'In attesa':'In lavorazione';rows=await getByStato(stato);}
  }else{rows=await getAllRecords();}
  if(currentFilter==='soon') rows=rows.filter(r=>isSoon(parseDate(r.dataScadenza)));
  if(q) rows=rows.filter(r=>buildSearchIndex(r).includes(q));
  rows=rows.filter(matchTechFilters);
  rows.sort((a,b)=>(b.updatedAt||'').localeCompare(a.updatedAt||''));
  const box=$('#activeFilterBox'),lab=$('#activeFilterLabel'); if(currentFilter){box.classList.remove('d-none');lab.textContent=FILTER_LABELS[currentFilter]||'Filtro attivo';}else{box.classList.add('d-none');lab.textContent='';}
  searchRows=rows; page=1; renderPager(searchRows.length); drawListPage();
}

/* Dettaglio (date IT) */
async function apri(id){
  const r=await getRecord(id),{images,thumbs}=await getPhotos(id);const img=images[0]||thumbs[0];
  const d=$('#detailContent');
  d.innerHTML=`
    ${img?`<img class="img-fluid mb-3" src="${img}" id="detailImg" style="cursor:pointer">`:''}
    <table class="table table-sm">
      <tr><th>Descrizione</th><td>${esc(r.descrizione)}</td></tr>
      <tr><th>Modello</th><td>${esc(r.modello)}</td></tr>
      <tr><th>Cliente</th><td>${esc(r.cliente)}</td></tr>
      <tr><th>Telefono</th><td>${esc(r.telefono)}</td></tr>
      <tr><th>Email</th><td>${esc(r.email)}</td></tr>
      <tr><th>Punta</th><td>${esc(r.punta||'')} ${r?.numPunte?`(${esc(r.numPunte)} punte)`:''}</td></tr>
      <tr><th>Stato pratica</th><td>${esc(r.statoPratica||'In attesa')}</td></tr>
      <tr><th>Preventivo</th><td>${esc(r.preventivoStato||'Non inviato')}</td></tr>
      <tr><th>Documento Trasporto</th><td>${esc(r.docTrasporto)}</td></tr>
      <tr><th>Data apertura</th><td>${fmtIT(r.dataApertura||r.dataArrivo||'')}</td></tr>
      <tr><th>Data accettazione</th><td>${fmtIT(r.dataAccettazione)}</td></tr>
      <tr><th>Data scadenza</th><td>${fmtIT(r.dataScadenza)}</td></tr>
      <tr><th>Note</th><td>${esc(r.note)}</td></tr>
    </table>`;
  const modal=new bootstrap.Modal('#detailModal'); modal.show();
  const imgEl=$('#detailImg'); if(imgEl) imgEl.addEventListener('click',()=>openImg(img));
  $('#btnPDF').onclick=()=>pdfRec(r,img);
  $('#btnEdit').onclick=()=>{modal.hide(); modifica(id);};
  $('#btnDelete').onclick=()=>{ deleteTargetId=id; new bootstrap.Modal('#confirmDeleteModal').show(); };
}

/* Full image modal */
function openImg(src){ if(!src) return; $('#imgFull').src=src; new bootstrap.Modal('#imgModal').show(); }

/* PDF (date IT) */
function pdfRec(r,img){
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({unit:'pt',format:'a4'});
  let y=40;
  doc.setFontSize(18); doc.text('Scheda riparazioni â€” Riepilogo',40,y); y+=24; doc.setFontSize(12);
  const L=(l,v)=>{doc.setFont(undefined,'bold');doc.text(l,40,y);doc.setFont(undefined,'normal');doc.text(': '+(v||''),180,y);y+=16;};
  const map={
    descrizione:'Descrizione',modello:'Modello',cliente:'Cliente',telefono:'Telefono',email:'Email',
    punta:'Punta',numPunte:'N. punte',statoPratica:'Stato pratica',preventivoStato:'Preventivo',
    docTrasporto:'Documento Trasporto',dataApertura:'Data apertura',dataAccettazione:'Data accettazione',
    dataScadenza:'Data scadenza',note:'Note'
  };
  Object.keys(map).forEach(k=>{
    let v=r[k];
    if(['dataApertura','dataAccettazione','dataScadenza'].includes(k)) v = fmtIT(v);
    if(k==='numPunte' && !v) return;
    if(r[k] || v) L(map[k], v);
  });
  if(img){try{doc.addImage(img,'JPEG',40,y+6,500,300);}catch(e){}}
  doc.save(`Scheda-${(r.descrizione||'').replace(/\s+/g,'_')}-${r.modello||''}.pdf`);
}

/* Backup/Ripristina */
async function backup(){const zip=new JSZip(),all=await getAllRecords();for(const r of all){zip.file(`records/${r.id}.json`,JSON.stringify(r,null,2));const {images,thumbs}=await getPhotos(r.id);images.forEach((d,i)=>zip.file(`photos/${r.id}-${i+1}.jpg`,d.split(',')[1],{base64:true}));thumbs.forEach((d,i)=>zip.file(`photos/${r.id}-${i+1}-thumb.jpg`,d.split(',')[1],{base64:true}));}const blob=await zip.generateAsync({type:'blob',compression:'DEFLATE'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='backup_scheda_riparazioni.zip';a.click();}
async function ripristina(e){const f=e.target.files?.[0];if(!f)return;const zip=await JSZip.loadAsync(f);const recs=Object.keys(zip.files).filter(k=>k.startsWith('records/')&&k.endsWith('.json'));for(const k of recs){const txt=await zip.files[k].async('string');const r=JSON.parse(txt);await putRecord(r);const photos=Object.keys(zip.files).filter(p=>p.startsWith('photos/')&&p.includes(r.id+'-')&&!p.includes('-thumb'));const thumbs=Object.keys(zip.files).filter(p=>p.startsWith('photos/')&&p.includes(r.id+'-')&&p.includes('-thumb'));const imgs=[],ths=[];for(const p of photos){const b=await zip.files[p].async('base64');imgs.push('data:image/jpeg;base64,'+b);}for(const p of thumbs){const b=await zip.files[p].async('base64');ths.push('data:image/jpeg;base64,'+b);}if(imgs.length||ths.length)await savePhotosWithThumbs(r.id,imgs,ths);}alert('Ripristino completato');sh('home');refreshDashboard();}

/* KPI â†’ Ricerca + dashboard */
function goToSearchWithFilter(filterKey){currentFilter=filterKey||null;sh('search');lista();}
async function refreshDashboard(){const all=await getAllRecords();const kpiTot=$('#kpiTot'),kpiAttesa=$('#kpiAttesa'),kpiLavor=$('#kpiLavor'),kpiSoon=$('#kpiSoon'),kpiCompl=$('#kpiCompl');const cAtt=all.filter(r=>(r.statoPratica||'')==='In attesa').length;const cLav=all.filter(r=>(r.statoPratica||'')==='In lavorazione').length;const cSoon=all.filter(r=>isSoon(parseDate(r.dataScadenza))).length;const cCompl=all.filter(r=>(r.statoPratica||'')==='Completata').length;kpiTot.textContent=all.length;kpiAttesa.textContent=cAtt;kpiLavor.textContent=cLav;kpiSoon.textContent=cSoon;kpiCompl.textContent=cCompl;await populateHomeOpenList();}

/* Debounce ricerca */
let searchTimer=null; function debouncedSearch(){clearTimeout(searchTimer);searchTimer=setTimeout(()=>{lista();},250);}

/* Wire-up */
document.addEventListener('DOMContentLoaded',()=>{
  const _stSel=document.getElementById('statoPratica'); if(_stSel){ _stSel.addEventListener('change', updateCompletionUI); }
  $('#btnHome').onclick=()=>{sh('home');refreshDashboard();};
  $('#btnSearch').onclick=()=>{currentFilter=null;sh('search');lista();};
  $('#newRecord').onclick=nuovo; $('#goSearch').onclick=()=>{currentFilter=null;sh('search');lista();};
  $('#cancelForm').onclick=()=>{sh('home');refreshDashboard();};
  $('#saveRecord').onclick=salva;

  // Ricerca (filtri tecnici)
  $('#btnDoSearch').onclick=lista; $('#q').addEventListener('input',debouncedSearch);
  $('#btnApplyFilters').onclick=()=>{techFilters.battCollettore=$('#f_battCollettore').value||'';techFilters.lunghezzaAsse=$('#f_lunghezzaAsse').value||'';techFilters.lunghezzaPacco=$('#f_lunghezzaPacco').value||'';techFilters.larghezzaPacco=$('#f_larghezzaPacco').value||'';techFilters.punta=$('#f_punta').value||'';techFilters.numPunte=$('#f_numPunte').value||'';lista();};
  $('#btnResetFilters').onclick=()=>{['f_battCollettore','f_lunghezzaAsse','f_lunghezzaPacco','f_larghezzaPacco','f_numPunte'].forEach(id=>{$('#'+id).value='';});$('#f_punta').value='';Object.keys(techFilters).forEach(k=>techFilters[k]='');lista();};
  ['kpiTotBtn','kpiAttesaBtn','kpiLavorBtn','kpiSoonBtn','kpiComplBtn'].forEach(id=>{const el=document.getElementById(id);if(el)el.addEventListener('click',()=>goToSearchWithFilter(el.dataset.filter));});
  $('#btnClearFilter').onclick=()=>{currentFilter=null;lista();};

  // backup
  $('#exportZip').onclick=backup; $('#importZip').addEventListener('change',ripristina);

  // delete
  $('#confirmDeleteBtn').addEventListener('click', async ()=>{if(!deleteTargetId)return;await deleteRecord(deleteTargetId);deleteTargetId=null;bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();lista();refreshDashboard();});

  // foto preview
  $('#photoInput').addEventListener('change',async e=>{const f=e.target.files?.[0];if(f)$('#photoPreview').src=await f2url(f);});
  $('#photoPreview').addEventListener('click',()=>{ const src=$('#photoPreview').src; if(!src) return; $('#imgCenter').src=src; new bootstrap.Modal('#imgModalCenter').show(); });

  
  // Gestione hint vuoto dell'anteprima (destra)
  const emptyHint = document.getElementById('emptyHint');
  const previewImg = document.getElementById('photoPreview');
  function updateEmptyHint(){
    if(previewImg && emptyHint){
      const hasSrc = !!previewImg.getAttribute('src');
      emptyHint.style.display = hasSrc ? 'none' : 'block';
    }
  }
  updateEmptyHint();
  document.getElementById('photoInput').addEventListener('change', async e=>{
    const f = e.target.files && e.target.files[0];
    if(f){
      const reader = new FileReader();
      reader.onload = ev => { previewImg.src = ev.target.result; updateEmptyHint(); };
      reader.readAsDataURL(f);
    }else{
      previewImg.removeAttribute('src'); updateEmptyHint();
    }
  });

  
  // === Gestione miniature e anteprima ===
  const thumbStrip = document.getElementById('thumbStrip');
  function clearThumbs(){ if(thumbStrip) thumbStrip.innerHTML=''; }
  function addThumb(src, active=false){
    if(!thumbStrip) return;
    const item = document.createElement('div');
    item.className = 'thumb-item' + (active?' active':'');
    const im = document.createElement('img');
    im.src = src;
    item.appendChild(im);
    item.addEventListener('click', ()=>{
      const preview = document.getElementById('photoPreview');
      if(preview){ preview.src = src; if(typeof updateEmptyHint==='function') updateEmptyHint(); }
      thumbStrip.querySelectorAll('.thumb-item').forEach(t=>t.classList.remove('active'));
      item.classList.add('active');
    });
    thumbStrip.appendChild(item);
  }
  async function fileToDataURL(file){
    return await new Promise(res=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(file); });
  }
  const photoInputEl = document.getElementById('photoInput');
  if(photoInputEl){
    photoInputEl.addEventListener('change', async (e)=>{
      const files = Array.from(e.target.files||[]);
      clearThumbs();
      if(files.length){
        const first = await fileToDataURL(files[0]);
        const preview = document.getElementById('photoPreview');
        if(preview){ preview.src = first; if(typeof updateEmptyHint==='function') updateEmptyHint(); }
        addThumb(first, true);
        for(const f of files.slice(1)){
          const data = await fileToDataURL(f);
          addThumb(data, false);
        }
      }else{
        const preview = document.getElementById('photoPreview');
        if(preview){ preview.removeAttribute('src'); if(typeof updateEmptyHint==='function') updateEmptyHint(); }
        clearThumbs();
      }
    }, { capture: true });
  }
  // Estendo modifica() per popolare miniature da archivio
  const __orig_modifica = modifica;
  modifica = async function(id){
    await __orig_modifica(id);
    if(!thumbStrip) return;
    clearThumbs();
    try{
      const p = await getPhotos(id);
      const imgs = (p && p.images) ? p.images : [];
      if(imgs.length){
        const preview = document.getElementById('photoPreview');
        if(preview && !preview.src) preview.src = imgs[0];
        addThumb(imgs[0], true);
        for(const s of imgs.slice(1)){ addThumb(s, false); }
        if(typeof updateEmptyHint==='function') updateEmptyHint();
      }
    }catch(err){ /* ignore */ }
  };

  refreshDashboard();
});
</script>
<!-- 1) Config con le chiavi -->
<script src="config.js"></script>

<!-- 2) Libreria Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- 3) (Opzionale) patch singleton per evitare warning client multipli -->
<script src="supabase-singleton.js"></script>

<!-- 4) Bridge della tua app -->
<script src="app-supabase.v6.3.3.js"></script>

<!-- 5) Script opzionali, tutti qui dentro il body -->


<script src="filters-exact-enforcer.js?v=1"></script>
